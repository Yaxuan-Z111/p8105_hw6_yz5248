---
title: "p8105_hw6_yz5248"
author: "yz5248"
date: "2025-11-15"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(broom)
library(purrr)
library(readr)
```

# Problem 1
```{r}
homicides_df = read_csv("homicide-data.csv")
```

## cleaning the data
```{r}
clean_df =
  homicides_df |>
  mutate(
    city_state = str_c(city, ", ", state),
    solved = if_else(
      disposition == "Closed by arrest", 1, 0
    ),
    victim_age = as.numeric(victim_age)
  ) |>
  filter(!city_state %in% c(
    "Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"
  )) |>
  filter(victim_race %in% c("Black", "White")) |>
  filter(victim_sex %in% c("Male", "Female")) |>
  mutate(
    victim_sex = as.factor(victim_sex)
  )|>
  drop_na(victim_age, victim_sex, victim_race)
```

## fitting GLM function
```{r}
baltimore_df =
  clean_df |>
  filter(city_state == "Baltimore, MD")

baltimore_fit =
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data = baltimore_df,
    family = binomial()
  )

baltimore_results =
  baltimore_fit |>
  broom::tidy(conf.int = TRUE, exponentiate = TRUE)

baltimore_results
```

```{r}
baltimore_OR_male =
  baltimore_results |>
  filter(term == "victim_sexMale") |>
  select(term, estimate, conf.low, conf.high)

baltimore_OR_male
```

## running for whole dataset
```{r}
nested_df =
  clean_df |>
  group_by(city_state) |>
  nest()

results_df =
  nested_df |>
  mutate(
    fit = map(data, ~ glm(
      solved ~ victim_age + victim_sex + victim_race,
      data = .x,
      family = binomial()
    )),
    
    tidy_fit = map(fit, ~ tidy(
      .x,
      conf.int = TRUE,
      exponentiate = TRUE
    ))
  ) |>
  unnest(tidy_fit) |>
  filter(term == "victim_sexMale") |>
  select(
    city_state, estimate, conf.low, conf.high
  )
results_df
```

## plotting the result
```{r}
results_plot =
  results_df |>
  arrange(estimate) |>   
  mutate(city_state = factor(city_state, levels = city_state)) |>
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  coord_flip() +
  theme_minimal(base_size = 10)

results_plot
```
The plot shows substantial variation across cities in the adjusted odds ratio for solving homicides involving male victims compared with female victims. In most cities, the estimated ORs are close to 1, and many confidence intervals include 1, suggesting little evidence of a strong gender difference in clearance rates after adjusting for age and race. However, several cities show ORs below 1, indicating lower clearance rates for male victims relative to female victims, while a few cities show ORs above 1. The wide confidence intervals seen in some cities—particularly those with smaller numbers of homicide cases—indicate substantial uncertainty in the estimated effects. Overall, the association between victim sex and homicide resolution varies by city, with no consistent pattern across locations.

# Problem 2
```{r}
library(p8105.datasets)
data("weather_df")
```

## generate the function
```{r}
bootstrap_est = function(df) {
  
  fit = lm(tmax ~ tmin + prcp, data = df)
  
  r2 = glance(fit)$r.squared
  
  coef_info = tidy(fit)
  beta1 = coef_info$estimate[coef_info$term == "tmin"]
  beta2 = coef_info$estimate[coef_info$term == "prcp"]
  
  tibble(
    r2 = r2,
    beta_ratio = beta1 / beta2
  )
}

```

## create a bootstrap framework
```{r}
set.seed(100)  

bootstrap_results =
  tibble(i = 1:5000) |>
  mutate(
    boot_sample = map(i, ~ sample_n(weather_df, size = nrow(weather_df), replace = TRUE)),
    boot_est = map(boot_sample, bootstrap_est)
  ) |>
  select(-boot_sample) |>
  unnest(boot_est)
bootstrap_results
```

## plotting the R^2 distribution
```{r}
dist_r2_plot =
  bootstrap_results |>
  ggplot(aes(x = r2)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  theme_minimal()
dist_r2_plot
```
The bootstrap distribution of $r^2$ is approximately symmetric and concentrated around a value near 0.94. This indicates that the linear model explains a consistently large proportion of the variability in 'tmax' across bootstrap samples. The distribution is fairly narrow, suggesting that $r^2$ is estimated with relatively low uncertainty and is stable across repeated resampling of the data.

## plotting the beta_ratio distribution
```{r}
dist_ratio_plot =
  bootstrap_results |>
  ggplot(aes(x = beta_ratio)) +
  geom_density(fill = "lightgreen", alpha = 0.5) +
  theme_minimal()
dist_ratio_plot
```
The bootstrap distribution of the coefficient ratio $β₁ / β₂$ is much more variable and strongly skewed. The distribution spreads widely, with values ranging from roughly –500 to –100 and a long left tail. This reflects substantial instability in the ratio, largely because $β₂$ is small and close to 0 in many samples, making the ratio highly sensitive to small changes in $β₂$. 

## R^2 95% Confidence Interval
```{r}
CI_R2 =
  bootstrap_results$r2 |>
  quantile(probs = c(0.025, 0.975))
CI_R2
```
The 95% confidence interval for $r^2$ is [0.9343259 0.9466045]

## Beta_ratio 95% Confidence Interval
```{r}
CI_ratio =
  bootstrap_results$beta_ratio |>
  quantile(probs = c(0.025, 0.975))
CI_ratio
```
The 95% confidence interval for $β₁ / β₂$ is [-280.5287 -125.6147]